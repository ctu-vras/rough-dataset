<launch>
  <arg name="bag"/>
  <arg name="out_bag" value="$(eval bag.replace('.bag', '').replace('.preproc', '') + '.points_filtered.bag')"/>
  <arg name="recompute_model" default="true" />

  <rosparam command="load" file="$(arg bag).params"/>
  <param name="/use_sim_time" value="true"/>
  
  <group ns="marv">
    <include file="$(find marv_description)/launch/description.launch" if="$(arg recompute_model)">
    </include>
  </group>

  <node name="play" pkg="rosbag" type="play" args="--clock --delay=0.1 --rate=0.5 '$(arg bag)'" required="true" output="screen">
    <remap from="points_filtered" to="points_filtered_orig" />
    <remap from="robot_bounding_box" to="robot_bounding_box_orig" />
    <remap from="robot_bounding_sphere" to="robot_bounding_sphere_orig" />
  </node>
  
  <node name="laser_nodelet_manager_nuc" pkg="nodelet" type="nodelet" args="manager" output="screen" required="true">
    <param name="num_worker_threads" value="4"/>
  </node>
  
  <include file="$(find marv_bringup)/launch/laser_filtering.launch">
    <arg name="nodelet_manager" value="laser_nodelet_manager_nuc"/>
  </include>

  <include file="$(find cras_ouster_driver)/launch/os_cloud_node.launch">
    <arg name="fields_to_publish" value="t,intensity,ambient,reflectivity"/>
    <arg name="keep_organized" value="true"/>
    <arg name="publish_invalid" value="false"/>
    <arg name="max_range" value="50.0"/>
    <arg name="nodelet_manager" value="laser_nodelet_manager_nuc"/>
  </include>

  <node pkg="nodelet" type="nodelet" name="pointcloud_motion_deskew" args="load PointCloud2Deskew laser_nodelet_manager_nuc" required="true">
    <remap from="input_point_cloud" to="os_cloud_node/points"/>
    <remap from="output_point_cloud" to="points_deskewed"/>
    <param name="fixed_frame_for_laser" value="odom"/>
  </node>

  <node name="rec" pkg="rosbag" type="record"
        args="--lz4 -O '$(arg out_bag)' points_filtered robot_bounding_box robot_bounding_sphere"
        output="screen" required="true">
  </node>
</launch>