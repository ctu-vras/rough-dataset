<launch>
  <arg name="bag"/>
  <arg name="out_bag" value="$(eval bag.replace('.bag', '').replace('.preproc', '') + '.points_filtered.bag')"/>
  <arg name="use_ouster_imu" default="true"/>

  <param name="/use_sim_time" value="true"/>

  <node name="play" pkg="rosbag" type="play" args="--clock --delay=0.1 '$(arg bag)'" required="true" output="screen"/>

  <node pkg="nodelet" type="nodelet" name="imu_filter" args="standalone imu_complementary_filter/ComplementaryFilterNodelet" if="$(arg use_ouster_imu)">
    <rosparam>
      use_mag: false
      orientation_stddev: 0.5
      gain_acc: 0.005
      do_adaptive_gain: false
      do_bias_estimation: false
      bias_alpha: 0.01
      publish_tf: false
      constant_dt: 0.01
    </rosparam>
    <remap from="imu/data_raw" to="os_cloud_node/imu" />
    <remap from="imu/data" to="os_cloud_node/imu/data" />
  </node>
  
  <node pkg="robot_localization" type="ekf_localization_node" name="ekf_localization">
    <param name="imu0" value="os_cloud_node/imu/data" if="$(arg use_ouster_imu)" />
    <param name="imu0" value="imu/data" unless="$(arg use_ouster_imu)" />
    <rosparam>
      odom_frame: odom
      base_link_frame: base_link
      world_frame: odom
      
      two_d_mode: false
      
      frequency: 20
      
      odom0: odom_2d
      odom0_config: [false, false, false,
                     false, false, false,
                     true, false, false,
                     false, false, true,
                     false, false, false]
      odom0_differential: false
      odom0_queue_size: 10
      
      imu0_config: [false, false, false,
                    true, true, false,
                    false, false, false,
                    false, false, true,
                    false, false, false]
      imu0_differential: false
      imu0_queue_size: 10
      
      initial_estimate_covariance: [1e-9, 0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    1e-9, 0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    1e-9, 0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    10,   0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    10,   0,    0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    1e-9, 0,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    1,    0,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    1,    0,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    1,    0,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    1,     0,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     1,     0,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     1,     0,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     1,    0,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    1,    0,
                                    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,     0,     0,     0,    0,    1]
    </rosparam>
    <remap from="odometry/filtered" to="odom" />
  </node>

  <node name="laser_nodelet_manager_nuc" pkg="nodelet" type="nodelet" args="manager" output="screen" required="true">
    <param name="num_worker_threads" value="4"/>
  </node>

  <node pkg="nodelet" type="nodelet" name="pointcloud_motion_deskew" args="load PointCloud2Deskew laser_nodelet_manager_nuc" required="true">
    <remap from="input_point_cloud" to="points"/>
    <remap from="output_point_cloud" to="points_deskewed"/>
    <param name="fixed_frame_for_laser" value="odom"/>
  </node>

  <include file="$(find tatra_bringup)/launch/laser_filtering.launch"/>
  
  <node name="rec" pkg="rosbag" type="record"
        args="--lz4 -O '$(arg out_bag)' points_filtered odom os_cloud_node/imu/data robot_bounding_box robot_bounding_sphere tf"
        output="screen" required="true">
  </node>
</launch>